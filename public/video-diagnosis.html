<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ Video Diagnosis Tool</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3748 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(45, 55, 72, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .section {
            background: rgba(45, 55, 72, 0.4);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .video-container {
            background: #000;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 8px;
            border: 2px solid #4a5568;
        }
        .btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }
        .btn.danger { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .btn.success { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.success { background: rgba(56, 161, 105, 0.2); border: 1px solid #38a169; color: #68d391; }
        .status.error { background: rgba(229, 62, 62, 0.2); border: 1px solid #e53e3e; color: #fc8181; }
        .status.info { background: rgba(66, 153, 225, 0.2); border: 1px solid #4299e1; color: #90cdf4; }
        .status.warning { background: rgba(237, 137, 54, 0.2); border: 1px solid #ed8936; color: #fbb040; }
        .log {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-card {
            background: rgba(26, 32, 44, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .emoji { font-size: 24px; margin-right: 10px; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4299e1;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ Paul Fernandez Video Diagnosis</h1>
            <p>å‹•ç”»å†ç”Ÿå•é¡Œã®è©³ç´°è¨ºæ–­ãƒ„ãƒ¼ãƒ«</p>
            <div id="globalStatus" class="status info">è¨ºæ–­æº–å‚™ä¸­...</div>
        </div>

        <div class="grid">
            <!-- Video Test Section -->
            <div class="section">
                <h2><span class="emoji">ğŸ¥</span>Video Playback Test</h2>
                
                <div class="video-container">
                    <h3>Minimal Version (2.5MB)</h3>
                    <video id="video1" controls preload="metadata" muted>
                        <source src="/videos/paul-fernandez-intro-minimal.mp4" type="video/mp4">
                        <div style="padding: 40px; text-align: center; color: #999;">
                            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“
                        </div>
                    </video>
                    <div>
                        <button class="btn" onclick="testPlay(1)">â–¶ï¸ å†ç”Ÿãƒ†ã‚¹ãƒˆ</button>
                        <button class="btn" onclick="testPause(1)">â¸ï¸ åœæ­¢</button>
                        <button class="btn" onclick="reloadVideo(1)">ğŸ”„ ãƒªãƒ­ãƒ¼ãƒ‰</button>
                        <button class="btn" onclick="downloadTest(1)">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
                    </div>
                    <div id="status1" class="status info">å¾…æ©Ÿä¸­...</div>
                </div>

                <div class="video-container">
                    <h3>Reference Video (External)</h3>
                    <video id="videoRef" controls preload="metadata" muted>
                        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                        å¤–éƒ¨å‹•ç”»ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“
                    </video>
                    <div>
                        <button class="btn" onclick="testPlay('Ref')">â–¶ï¸ å‚è€ƒå‹•ç”»å†ç”Ÿ</button>
                    </div>
                    <div id="statusRef" class="status info">å¤–éƒ¨å‹•ç”» - ãƒ–ãƒ©ã‚¦ã‚¶åŸºæœ¬æ©Ÿèƒ½ç¢ºèªç”¨</div>
                </div>
            </div>

            <!-- System Info Section -->
            <div class="section">
                <h2><span class="emoji">ğŸ’»</span>System Information</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>ğŸŒ Browser</h4>
                        <div id="browserInfo">Loading...</div>
                    </div>
                    <div class="info-card">
                        <h4>ğŸ¬ Video Support</h4>
                        <div id="videoSupport">Testing...</div>
                    </div>
                    <div class="info-card">
                        <h4>ğŸŒ Network</h4>
                        <div id="networkInfo">Checking...</div>
                    </div>
                    <div class="info-card">
                        <h4>âš¡ Performance</h4>
                        <div id="performanceInfo">Analyzing...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Details Section -->
        <div class="section">
            <h2><span class="emoji">ğŸ“Š</span>Video Details</h2>
            <div>
                <button class="btn" onclick="analyzeVideo()">ğŸ” è©³ç´°åˆ†æ</button>
                <button class="btn" onclick="networkTest()">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn success" onclick="runFullDiagnosis()">ğŸš€ å®Œå…¨è¨ºæ–­å®Ÿè¡Œ</button>
            </div>
            <div id="videoDetails" class="status info" style="margin-top: 15px;">
                ã€Œè©³ç´°åˆ†æã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ç”»æƒ…å ±ã‚’è¡¨ç¤º
            </div>
        </div>

        <!-- Log Section -->
        <div class="section">
            <h2><span class="emoji">ğŸ“</span>Diagnostic Log</h2>
            <div>
                <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                <button class="btn" onclick="exportLog()">ğŸ“‹ ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
            <div id="diagnosticLog" class="log">
                è¨ºæ–­ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
            </div>
        </div>
    </div>

    <script>
        // Logging system
        const log = (message, type = 'info', component = 'SYSTEM') => {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logDiv = document.getElementById('diagnosticLog');
            const colors = {
                info: '#90cdf4',
                success: '#68d391', 
                error: '#fc8181',
                warning: '#fbb040'
            };
            
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #a0aec0;">[${timestamp}]</span> <span style="color: ${colors[type]}; font-weight: bold;">[${component}]</span> ${message}`;
            entry.style.marginBottom = '5px';
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] [${component}] ${message}`);
        };

        const updateStatus = (id, message, type = 'info') => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        };

        const updateGlobalStatus = (message, type = 'info') => {
            updateStatus('globalStatus', message, type);
        };

        // Video testing functions
        const testPlay = async (videoId) => {
            const video = document.getElementById(`video${videoId}`);
            const statusId = `status${videoId}`;
            
            try {
                updateStatus(statusId, 'å†ç”Ÿã‚’è©¦è¡Œä¸­...', 'info');
                log(`Video ${videoId} play attempt started`, 'info', 'PLAYER');
                
                await video.play();
                updateStatus(statusId, 'âœ… å†ç”ŸæˆåŠŸï¼', 'success');
                log(`Video ${videoId} playback successful`, 'success', 'PLAYER');
                updateGlobalStatus('âœ… å‹•ç”»å†ç”ŸæˆåŠŸ - å•é¡Œãªã—', 'success');
                
            } catch (error) {
                updateStatus(statusId, `âŒ å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`Video ${videoId} playback failed: ${error.message}`, 'error', 'PLAYER');
                updateGlobalStatus('âŒ å‹•ç”»å†ç”Ÿã«å•é¡ŒãŒã‚ã‚Šã¾ã™', 'error');
            }
        };

        const testPause = (videoId) => {
            const video = document.getElementById(`video${videoId}`);
            video.pause();
            updateStatus(`status${videoId}`, 'â¸ï¸ åœæ­¢', 'info');
            log(`Video ${videoId} paused`, 'info', 'PLAYER');
        };

        const reloadVideo = (videoId) => {
            const video = document.getElementById(`video${videoId}`);
            updateStatus(`status${videoId}`, 'ğŸ”„ ãƒªãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
            video.load();
            log(`Video ${videoId} reloaded`, 'info', 'PLAYER');
        };

        const downloadTest = async (videoId) => {
            try {
                updateStatus(`status${videoId}`, 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆä¸­...', 'info');
                log('Starting download test...', 'info', 'NETWORK');
                
                const response = await fetch('/videos/paul-fernandez-intro-minimal.mp4', { method: 'HEAD' });
                
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const type = response.headers.get('content-type');
                    updateStatus(`status${videoId}`, `âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ (${Math.round(size/1024/1024*10)/10}MB, ${type})`, 'success');
                    log(`Download test successful: ${Math.round(size/1024/1024*10)/10}MB, ${type}`, 'success', 'NETWORK');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateStatus(`status${videoId}`, `âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`Download test failed: ${error.message}`, 'error', 'NETWORK');
            }
        };

        const analyzeVideo = () => {
            const video = document.getElementById('video1');
            const details = document.getElementById('videoDetails');
            
            const analysis = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div><strong>ğŸ¯ Ready State:</strong><br>${getReadyStateText(video.readyState)}</div>
                    <div><strong>ğŸŒ Network State:</strong><br>${getNetworkStateText(video.networkState)}</div>
                    <div><strong>â±ï¸ Duration:</strong><br>${video.duration ? Math.round(video.duration*10)/10 + 'ç§’' : 'ä¸æ˜'}</div>
                    <div><strong>ğŸ“ Current Time:</strong><br>${Math.round(video.currentTime*10)/10}ç§’</div>
                    <div><strong>â¸ï¸ Paused:</strong><br>${video.paused ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                    <div><strong>ğŸ”š Ended:</strong><br>${video.ended ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                    <div><strong>ğŸ“± Source:</strong><br>${video.currentSrc ? 'ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿' : 'æœªãƒ­ãƒ¼ãƒ‰'}</div>
                    <div><strong>âš ï¸ Error:</strong><br>${video.error ? `Code: ${video.error.code}` : 'ãªã—'}</div>
                </div>
            `;
            
            details.innerHTML = analysis;
            log('Video analysis completed', 'info', 'ANALYZER');
        };

        const networkTest = async () => {
            updateGlobalStatus('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            log('Starting comprehensive network test...', 'info', 'NETWORK');
            
            try {
                // Test various video URLs
                const tests = [
                    { url: '/videos/paul-fernandez-intro-minimal.mp4', name: 'Minimalç‰ˆ' },
                    { url: '/videos/paul-fernandez-intro-compatible.mp4', name: 'Compatibleç‰ˆ' },
                    { url: '/videos/paul-fernandez-intro.mp4', name: 'æ¨™æº–ç‰ˆ' },
                ];
                
                for (const test of tests) {
                    try {
                        const response = await fetch(test.url, { method: 'HEAD' });
                        const size = response.headers.get('content-length');
                        log(`${test.name}: âœ… åˆ©ç”¨å¯èƒ½ (${Math.round(size/1024/1024*10)/10}MB)`, response.ok ? 'success' : 'warning', 'NETWORK');
                    } catch (error) {
                        log(`${test.name}: âŒ ã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'error', 'NETWORK');
                    }
                }
                
                updateGlobalStatus('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                log(`Network test failed: ${error.message}`, 'error', 'NETWORK');
                updateGlobalStatus('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', 'error');
            }
        };

        const runFullDiagnosis = async () => {
            updateGlobalStatus('ğŸš€ å®Œå…¨è¨ºæ–­å®Ÿè¡Œä¸­...', 'info');
            log('=== FULL DIAGNOSIS STARTED ===', 'info', 'DIAGNOSTIC');
            
            // Test all components
            await downloadTest(1);
            await testPlay(1);
            analyzeVideo();
            await networkTest();
            
            log('=== FULL DIAGNOSIS COMPLETED ===', 'success', 'DIAGNOSTIC');
            updateGlobalStatus('âœ… å®Œå…¨è¨ºæ–­å®Œäº†', 'success');
        };

        const clearLog = () => {
            document.getElementById('diagnosticLog').innerHTML = '';
            log('Log cleared', 'info', 'SYSTEM');
        };

        const exportLog = () => {
            const logContent = document.getElementById('diagnosticLog').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video-diagnosis-${new Date().toISOString().slice(0,16)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Log exported', 'success', 'SYSTEM');
        };

        // Helper functions
        const getReadyStateText = (state) => {
            const states = ['HAVE_NOTHING', 'HAVE_METADATA', 'HAVE_CURRENT_DATA', 'HAVE_FUTURE_DATA', 'HAVE_ENOUGH_DATA'];
            return `${state} (${states[state] || 'UNKNOWN'})`;
        };

        const getNetworkStateText = (state) => {
            const states = ['NETWORK_EMPTY', 'NETWORK_IDLE', 'NETWORK_LOADING', 'NETWORK_NO_SOURCE'];
            return `${state} (${states[state] || 'UNKNOWN'})`;
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('Video Diagnosis Tool initialized', 'success', 'SYSTEM');
            updateGlobalStatus('è¨ºæ–­ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº† - ãƒ†ã‚¹ãƒˆé–‹å§‹å¯èƒ½', 'success');
            
            // Browser info
            document.getElementById('browserInfo').innerHTML = `
                <div style="font-size: 12px;">
                    <div><strong>Browser:</strong> ${navigator.userAgent.split(' ')[0]}</div>
                    <div><strong>Platform:</strong> ${navigator.platform}</div>
                    <div><strong>Language:</strong> ${navigator.language}</div>
                </div>
            `;
            
            // Video support
            const video = document.createElement('video');
            document.getElementById('videoSupport').innerHTML = `
                <div style="font-size: 12px;">
                    <div><strong>MP4:</strong> ${video.canPlayType('video/mp4') || 'ä¸æ˜'}</div>
                    <div><strong>H.264:</strong> ${video.canPlayType('video/mp4; codecs="avc1.42E01E"') || 'ä¸æ˜'}</div>
                    <div><strong>WebM:</strong> ${video.canPlayType('video/webm') || 'ä¸æ˜'}</div>
                </div>
            `;
            
            // Network info
            document.getElementById('networkInfo').innerHTML = `
                <div style="font-size: 12px;">
                    <div><strong>Online:</strong> ${navigator.onLine ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                    <div><strong>Connection:</strong> ${navigator.connection?.effectiveType || 'ä¸æ˜'}</div>
                    <div><strong>URL:</strong> ${window.location.href}</div>
                </div>
            `;
            
            // Performance info
            document.getElementById('performanceInfo').innerHTML = `
                <div style="font-size: 12px;">
                    <div><strong>Memory:</strong> ${navigator.deviceMemory || 'ä¸æ˜'}GB</div>
                    <div><strong>Cores:</strong> ${navigator.hardwareConcurrency || 'ä¸æ˜'}</div>
                    <div><strong>Viewport:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                </div>
            `;

            // Set up video event listeners
            const video1 = document.getElementById('video1');
            const videoRef = document.getElementById('videoRef');

            [video1, videoRef].forEach((video, index) => {
                const id = index === 0 ? '1' : 'Ref';
                
                video.addEventListener('loadstart', () => log(`Video ${id} load started`, 'info', 'VIDEO'));
                video.addEventListener('loadedmetadata', () => log(`Video ${id} metadata loaded`, 'success', 'VIDEO'));
                video.addEventListener('loadeddata', () => log(`Video ${id} data loaded`, 'success', 'VIDEO'));
                video.addEventListener('canplay', () => log(`Video ${id} can play`, 'success', 'VIDEO'));
                video.addEventListener('canplaythrough', () => log(`Video ${id} can play through`, 'success', 'VIDEO'));
                video.addEventListener('error', (e) => {
                    const error = video.error;
                    log(`Video ${id} error: Code ${error?.code} - ${error?.message}`, 'error', 'VIDEO');
                });
                video.addEventListener('play', () => log(`Video ${id} started playing`, 'success', 'VIDEO'));
                video.addEventListener('pause', () => log(`Video ${id} paused`, 'info', 'VIDEO'));
                video.addEventListener('ended', () => log(`Video ${id} ended`, 'info', 'VIDEO'));
            });
        });
    </script>
</body>
</html>
